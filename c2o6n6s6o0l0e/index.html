<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>课程管理 - 莱西四中</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/css/jquery.dataTables.min.css">
</head>
<body>
<div class="container">
<!--    导航栏start-->
    <div class="row clearfix">
        <div class="col-md-12 column">
            <nav class="navbar navbar-default" role="navigation">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/c2o6n6s6o0l0e">控制面板</a>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">课程<strong class="caret"></strong></a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="/c2o6n6s6o0l0e">课程管理</a>
                                </li>
                                <li class="divider"></li>
                                <li>
                                    <a href="/c2o6n6s6o0l0e/lesson.html">添加课程</a>
                                </li>
                            </ul>
                        </li>
                    </ul>

<!--                    <ul class="nav navbar-nav navbar-right">-->
<!--                        <li>-->
<!--                            <a href="#">Link</a>-->
<!--                        </li>-->
<!--                        <li class="dropdown">-->
<!--                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown<strong class="caret"></strong></a>-->
<!--                            <ul class="dropdown-menu">-->
<!--                                <li>-->
<!--                                    <a href="#">Action</a>-->
<!--                                </li>-->
<!--                                <li>-->
<!--                                    <a href="#">Another action</a>-->
<!--                                </li>-->
<!--                                <li>-->
<!--                                    <a href="#">Something else here</a>-->
<!--                                </li>-->
<!--                                <li class="divider">-->
<!--                                </li>-->
<!--                                <li>-->
<!--                                    <a href="#">Separated link</a>-->
<!--                                </li>-->
<!--                            </ul>-->
<!--                        </li>-->
<!--                    </ul>-->

                </div>
            </nav>
        </div>
    </div>
<!--    导航栏end-->

    <div class="row clearfix">
        <div class="col-md-12 column">
            <h3>
                OldTaoge Junior-Senior Web CMS Console
            </h3>
        </div>
    </div>



    <div class="row clearfix">
        <div class="col-md-12 column">
            <table id="main_table" class="table table-bordered table-hover table-striped">
                <thead>
                <tr>
                    <th>编号</th>
                    <th>日期</th>
                    <th>科目</th>
                    <th>内容</th>
                    <th>管理</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/keycloak-js@12.0.4/dist/keycloak.min.js"></script>
<script>
    const keycloak = new Keycloak({
        "clientId": "jun-sen-web",
        "url": "https://openid.oldtaoge.space/oauth2",
        "realm": "master",
        "enableLogging": true
    });

    keycloak.init({
        "onLoad": 'login-required'
    }).then(function(authenticated) {
        if(!authenticated) {
            window.location.reload();
        } else {
            console.log('Authenticated');
            app().initDatatable();
        }
    });

    const API_PREFIX = "https://api-jun-sen.edu.oldtaoge.space:21286/apiv1/";
    // const API_PREFIX = "http://localhost:8080/";

    let app = function () {
        function initDatatable() {
            $('#main_table').DataTable( {
                "paging": true,
                "info": true,
                "lengthChange": false,
                "ordering": false,
                "processing": true,
                "searching": false,
                "serverSide": true,
                "deferRender": true,
                ajax: {
                    url: API_PREFIX + 'lessons/dtp',
                    type: 'GET'
                },
                columns: [
                    { data: 'id' },
                    { data: 'date' },
                    { data: 'subject' },
                    { data: 'content' },
                    { data: 'file',
                        render: function (data, type, row, meta) {
                            let redata = ''
                            let files = JSON.parse(data)
                            redata += "<a href='lesson.html?id="+row.id+"'>信息编辑&nbsp</a>"
                            redata += "<a href='file.html?id="+row.id+"'>&nbsp文件管理&nbsp</a>"
                            redata += "<a href='javascript:void(0)' onclick='app().deleteLesson("+row.id+")'>&nbsp删除</a>"
                            return redata;
                        }
                    }
                ],
                language:{
                    "processing": "处理中...",
                    "lengthMenu": "显示 _MENU_ 项结果",
                    "zeroRecords": "没有匹配结果",
                    "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "infoFiltered": "(由 _MAX_ 项结果过滤)",
                    "infoPostFix": "",
                    "search": "搜索:",
                    "searchPlaceholder": "搜索...",
                    "url": "",
                    "emptyTable": "表中数据为空",
                    "loadingRecords": "载入中...",
                    "infoThousands": ",",
                    "paginate": {
                        "first": "首页",
                        "previous": "上页",
                        "next": "下页",
                        "last": "末页"
                    },
                    "aria": {
                        "paginate": {
                            "first": "首页",
                            "previous": "上页",
                            "next": "下页",
                            "last": "末页"
                        },
                        "sortAscending": "以升序排列此列",
                        "sortDescending": "以降序排列此列"
                    },
                    "thousands": "."
                }
            } );
        }
        function deleteLesson(id) {
            if (confirm("确定删除" + id + "?"))
            {
                keycloak.updateToken(30).then(function() {
                    $.ajax({
                        url: API_PREFIX + "upload/lessons/" + id,
                        type: "DELETE",
                        async: false,
                        headers: {
                            "Authorization": "Bearer " + keycloak.token
                        },
                        complete: function (xhr, status) {
                            location.reload();
                        }
                    })
                }).catch(function() {
                    alert('Failed to refresh token');
                });

            }
        }

        return {
            initDatatable: initDatatable,
            deleteLesson: deleteLesson
        }
    }

</script>
</html>