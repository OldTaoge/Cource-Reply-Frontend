<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>课程管理 - 莱西四中</title>
</head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropzone@5.8.1/dist/min/basic.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropzone@5.8.1/dist/min/dropzone.min.css">
<body>

<div class="container">
    <div class="row clearfix">
        <div class="col-md-12 column">
            <div class="page-header">
                <h1>
                    课程 <small id="header-desc"></small>
                </h1>
            </div>
        </div>
    </div>

    <div class="row clearfix">
        <div class="col-md-12 column">
            <div class="form-group">
                <label for="mediaUploader">上传回放</label>
                <div class="dropzone" id="mediaUploader">
                    <div class="am-text-success dz-message">
                        将文件拖拽到此处<br>或点此打开文件管理器选择文件
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row clearfix">
        <div class="col-md-12 column">
            <form id="mainForm" enctype="multipart/form-data">
                <input type="hidden" id="input-hidden-id" name="id" value="0">
                <input type="hidden" id="mediaFlag" name="mediaFlag" value="notModify">
                <input type="hidden" id="form-token" name="token">

                <div class="form-group">
                    <label for="date">日期</label>
                    <input type="date" class="form-control" id="date" name="date">
                </div>
                <div class="form-group">
                    <label for="subject">科目</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="科目">
                </div>
                <div class="form-group">
                    <label for="content">内容</label>
                    <input type="text" class="form-control" id="content" name="content" placeholder="内容">
                </div>
                <button type="button" id="formButton" class="btn btn-default">提交</button>
            </form>
        </div>
    </div>
</div>




</body>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dropzone@5.8.1/dist/min/dropzone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/keycloak-js@12.0.4/dist/keycloak.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-form@4.3.0/dist/jquery.form.min.js"></script>

<script>
    Dropzone.autoDiscover = false;

    const keycloak = new Keycloak({
        "clientId": "jun-sen-web",
        "url": "https://openid.oldtaoge.space/oauth2",
        "realm": "master",
        "enableLogging": true
    });

    keycloak.init({
        "onLoad": 'login-required'
    }).then(function(authenticated) {
        if(!authenticated) {
            window.location.reload();
        } else {
            console.log('Authenticated');
            $("#form-token")[0].value = keycloak.token;
            app().init();
        }
    });

    const API_PREFIX = "https://api-jun-sen.edu.oldtaoge.space:21286/apiv1/";
    // const API_PREFIX = "http://localhost:8080/";
    let GINFO;

    let app = function () {
        function getUrlParam(name) {
            let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            let r = window.location.search.substr(1).match(reg);  //匹配目标参数
            if (r != null) return unescape(r[2]); return null; //返回参数值
        }
        _id = getUrlParam("id");
        let _mediaFlag = '';
        function init() {
            if (_id !== null)
            {
                $("#header-desc")[0].innerText = "修改";
                $.get(API_PREFIX + "lessons/" + _id, function (response) {
                    GINFO = response.data;
                    console.log(GINFO)
                    $("#input-hidden-id")[0].value = GINFO.id;
                    $("#date")[0].value = GINFO.date;
                    $("#subject")[0].value = GINFO.subject;
                    $("#content")[0].value = GINFO.content;
                });
            }
            else
            {
                $("#header-desc")[0].innerText = "新建";
            }

            $("#formButton").on("click", function () {
                $.ajax({
                    type: "POST",   //提交的方法
                    headers: {
                        "Authorization": "Bearer " + keycloak.token
                    },
                    url: API_PREFIX + "upload/form", //提交的地址
                    data:$('#mainForm').serialize(),// 序列化表单值
                    async: false,
                    error: function(request) {  //失败的话
                        alert("Connection error");
                    },
                    success: function(data) {  //成功
                        window.location.href="https://jun-sen.edu.oldtaoge.space/c2o6n6s6o0l0e/"
                    }
                });
                $("#formButton").off("click");
            });
            var myDropzone = new Dropzone("#mediaUploader", {
                url: API_PREFIX + "upload/media",
                headers: {
                    "Authorization": "Bearer " + keycloak.token
                },
                maxFiles: 1,
                timeout: 3600000,
                maxFilesize: 1024,
                addRemoveLinks: true,
                method: 'post',
                success: function (file, response, e) {
                    console.log(response)
                    $("#mediaFlag")[0].value = _mediaFlag = response.flag

                }
            });
        }

        return {
            init: init
        }
    }

</script>

</html>
